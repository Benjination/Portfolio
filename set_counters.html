<!DOCTYPE html>
<html>
<head>
    <title>Set Counter Values</title>
</head>
<body>
    <h1>Setting Counter Values</h1>
    <div id="status">Setting counters...</div>
    <div id="debug"></div>

    <script>
        const FIRESTORE_PROJECT_ID = "portfolio-7148b";
        const FIRESTORE_COUNTERS_URL = `https://firestore.googleapis.com/v1/projects/${FIRESTORE_PROJECT_ID}/databases/(default)/documents/counters`;

        function log(message) {
            console.log(message);
            const debug = document.getElementById('debug');
            debug.innerHTML += message + '<br>';
        }

        async function setCounter(documentId, value) {
            log(`Setting ${documentId} to ${value}...`);
            
            const document = {
                fields: {
                    count: {
                        integerValue: value.toString()
                    },
                    last_updated: {
                        timestampValue: new Date().toISOString()
                    }
                }
            };

            const url = `${FIRESTORE_COUNTERS_URL}/${documentId}`;
            
            try {
                log(`Trying PATCH to ${url}`);
                
                // Try PATCH first (update existing)
                const patchResponse = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(document)
                });

                log(`PATCH response: ${patchResponse.status}`);

                if (patchResponse.ok) {
                    log(`✅ Successfully updated ${documentId} to ${value}`);
                    return true;
                }

                // If PATCH fails, try POST (create new)
                const createUrl = `${FIRESTORE_COUNTERS_URL}?documentId=${documentId}`;
                log(`Trying POST to ${createUrl}`);
                
                const postResponse = await fetch(createUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(document)
                });

                log(`POST response: ${postResponse.status}`);

                if (postResponse.ok) {
                    log(`✅ Successfully created ${documentId} with value ${value}`);
                    return true;
                }

                log(`❌ Failed to set ${documentId}: PATCH=${patchResponse.status}, POST=${postResponse.status}`);
                
                // Log response text for debugging
                const patchText = await patchResponse.text();
                const postText = await postResponse.text();
                log(`PATCH response: ${patchText}`);
                log(`POST response: ${postText}`);
                
                return false;
            } catch (error) {
                log(`❌ Error setting ${documentId}: ${error.message}`);
                return false;
            }
        }

        async function verifyCounter(documentId) {
            const url = `${FIRESTORE_COUNTERS_URL}/${documentId}`;
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    const count = data.fields?.count?.integerValue || '0';
                    log(`Current ${documentId}: ${count}`);
                    return parseInt(count);
                } else {
                    log(`Could not fetch ${documentId}: ${response.status}`);
                    return 0;
                }
            } catch (error) {
                log(`Error fetching ${documentId}: ${error.message}`);
                return 0;
            }
        }

        async function setCounters() {
            const status = document.getElementById('status');
            
            log('Starting counter setup...');
            
            // First verify current values
            log('Checking current values...');
            await verifyCounter('site_visits');
            await verifyCounter('game_plays');
            
            status.innerHTML = 'Setting site visits to 127...';
            const siteSuccess = await setCounter('site_visits', 127);
            
            status.innerHTML = 'Setting game plays to 10...';
            const gameSuccess = await setCounter('game_plays', 10);
            
            // Verify the new values
            log('Verifying new values...');
            const newSiteVisits = await verifyCounter('site_visits');
            const newGamePlays = await verifyCounter('game_plays');
            
            if (siteSuccess && gameSuccess) {
                status.innerHTML = `✅ Both counters set successfully!<br>Site visits: ${newSiteVisits}<br>Game plays: ${newGamePlays}`;
                log('✅ Setup complete!');
            } else {
                status.innerHTML = '❌ Some counters failed to update. Check console for details.';
                log('❌ Setup failed!');
            }
        }

        // Run when page loads
        setCounters();
    </script>
</body>
</html>
